generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION
// ============================================================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  apiKeys ApiKey[]

  @@map("users")
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  name      String
  keyHash   String    @map("key_hash")
  keyPrefix String    @map("key_prefix") @db.VarChar(12)
  lastUsed  DateTime? @map("last_used")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyPrefix])
  @@index([userId])
  @@map("api_keys")
}

// ============================================================================
// CORE DOMAIN
// ============================================================================

model Definition {
  id        String   @id @default(cuid())
  parentId  String?  @map("parent_id")
  name      String
  content   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Definition?  @relation("DefinitionVersions", fields: [parentId], references: [id])
  children Definition[] @relation("DefinitionVersions")

  runs      Run[]
  scenarios Scenario[]

  @@index([parentId])
  @@map("definitions")
}

model Run {
  id           String    @id @default(cuid())
  definitionId String    @map("definition_id")
  experimentId String?   @map("experiment_id")
  status       RunStatus @default(PENDING)
  config       Json      @db.JsonB
  progress     Json?     @db.JsonB
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  definition Definition  @relation(fields: [definitionId], references: [id])
  experiment Experiment? @relation(fields: [experimentId], references: [id])

  transcripts     Transcript[]
  analysisResults AnalysisResult[]
  baselineFor     RunComparison[]  @relation("BaselineRun")
  comparisonFor   RunComparison[]  @relation("ComparisonRun")
  scenarioSelections RunScenarioSelection[]

  @@index([definitionId])
  @@index([experimentId])
  @@index([status])
  @@map("runs")
}

enum RunStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model Transcript {
  id          String   @id @default(cuid())
  runId       String   @map("run_id")
  scenarioId  String?  @map("scenario_id")
  targetModel String   @map("target_model")
  content     Json     @db.JsonB
  turnCount   Int      @map("turn_count")
  tokenCount  Int      @map("token_count")
  durationMs  Int      @map("duration_ms")
  createdAt   DateTime @default(now()) @map("created_at")

  run      Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario Scenario? @relation(fields: [scenarioId], references: [id])

  @@index([runId])
  @@index([scenarioId])
  @@index([targetModel])
  @@map("transcripts")
}

model Scenario {
  id           String   @id @default(cuid())
  definitionId String   @map("definition_id")
  name         String
  content      Json     @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at")

  definition  Definition   @relation(fields: [definitionId], references: [id])
  transcripts Transcript[]
  runSelections RunScenarioSelection[]

  @@index([definitionId])
  @@map("scenarios")
}

// Join table to track which scenarios were sampled for a run
model RunScenarioSelection {
  id         String   @id @default(cuid())
  runId      String   @map("run_id")
  scenarioId String   @map("scenario_id")
  createdAt  DateTime @default(now()) @map("created_at")

  run      Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario Scenario @relation(fields: [scenarioId], references: [id])

  @@unique([runId, scenarioId])
  @@index([runId])
  @@index([scenarioId])
  @@map("run_scenario_selections")
}

// ============================================================================
// ANALYSIS & EXPERIMENTS
// ============================================================================

model Experiment {
  id           String   @id @default(cuid())
  name         String
  hypothesis   String?
  analysisPlan Json?    @map("analysis_plan") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  runs        Run[]
  comparisons RunComparison[]

  @@map("experiments")
}

model RunComparison {
  id              String   @id @default(cuid())
  experimentId    String?  @map("experiment_id")
  baselineRunId   String   @map("baseline_run_id")
  comparisonRunId String   @map("comparison_run_id")
  deltaData       Json?    @map("delta_data") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at")

  experiment    Experiment? @relation(fields: [experimentId], references: [id])
  baselineRun   Run         @relation("BaselineRun", fields: [baselineRunId], references: [id])
  comparisonRun Run         @relation("ComparisonRun", fields: [comparisonRunId], references: [id])

  @@index([experimentId])
  @@index([baselineRunId])
  @@index([comparisonRunId])
  @@map("run_comparisons")
}

model AnalysisResult {
  id           String         @id @default(cuid())
  runId        String         @map("run_id")
  analysisType String         @map("analysis_type")
  inputHash    String         @map("input_hash")
  codeVersion  String         @map("code_version")
  output       Json           @db.JsonB
  status       AnalysisStatus @default(CURRENT)
  createdAt    DateTime       @default(now()) @map("created_at")

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([analysisType])
  @@index([status])
  @@map("analysis_results")
}

enum AnalysisStatus {
  CURRENT
  SUPERSEDED
}

model Rubric {
  id        String   @id @default(cuid())
  version   Int      @unique
  content   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")

  @@map("rubrics")
}

// ============================================================================
// COHORTS (for segment analysis)
// ============================================================================

model Cohort {
  id        String   @id @default(cuid())
  name      String
  criteria  Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("cohorts")
}
