generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION
// ============================================================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String?
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  apiKeys ApiKey[]

  @@map("users")
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  name      String
  keyHash   String    @unique @map("key_hash")
  keyPrefix String    @map("key_prefix") @db.VarChar(12)
  lastUsed  DateTime? @map("last_used")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyPrefix])
  @@index([userId])
  @@map("api_keys")
}

// ============================================================================
// CORE DOMAIN
// ============================================================================

model Definition {
  id             String    @id @default(cuid())
  parentId       String?   @map("parent_id")
  name           String
  content        Json      @db.JsonB
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  lastAccessedAt DateTime? @map("last_accessed_at")
  deletedAt      DateTime? @map("deleted_at")

  parent   Definition?  @relation("DefinitionVersions", fields: [parentId], references: [id])
  children Definition[] @relation("DefinitionVersions")

  runs      Run[]
  scenarios Scenario[]
  tags      DefinitionTag[]

  @@index([parentId])
  @@map("definitions")
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  definitions DefinitionTag[]

  @@map("tags")
}

model DefinitionTag {
  id           String    @id @default(cuid())
  definitionId String    @map("definition_id")
  tagId        String    @map("tag_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")

  definition Definition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  tag        Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([definitionId, tagId])
  @@index([definitionId])
  @@index([tagId])
  @@map("definition_tags")
}

model Run {
  id                 String    @id @default(cuid())
  definitionId       String    @map("definition_id")
  experimentId       String?   @map("experiment_id")
  status             RunStatus @default(PENDING)
  config             Json      @db.JsonB
  progress           Json?     @db.JsonB
  startedAt          DateTime? @map("started_at")
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  lastAccessedAt     DateTime? @map("last_accessed_at")
  // Retention settings (for future pruning)
  retentionDays      Int?      @map("retention_days")
  archivePermanently Boolean   @default(true) @map("archive_permanently")

  definition Definition  @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  experiment Experiment? @relation(fields: [experimentId], references: [id])

  transcripts     Transcript[]
  analysisResults AnalysisResult[]
  baselineFor     RunComparison[]  @relation("BaselineRun")
  comparisonFor   RunComparison[]  @relation("ComparisonRun")
  scenarioSelections RunScenarioSelection[]

  @@index([definitionId])
  @@index([experimentId])
  @@index([status])
  @@map("runs")
}

enum RunStatus {
  PENDING
  RUNNING
  PAUSED
  SUMMARIZING   // Probing complete, generating summaries
  COMPLETED
  FAILED
  CANCELLED
}

model Transcript {
  id                 String    @id @default(cuid())
  runId              String    @map("run_id")
  scenarioId         String?   @map("scenario_id")
  // Model versioning (renamed from target_model for consistency)
  modelId            String    @map("model_id")
  modelVersion       String?   @map("model_version")
  // Definition snapshot (captures exact definition at run time)
  definitionSnapshot Json?     @map("definition_snapshot") @db.JsonB
  // Transcript content
  content            Json      @db.JsonB
  turnCount          Int       @map("turn_count")
  tokenCount         Int       @map("token_count")
  durationMs         Int       @map("duration_ms")
  createdAt          DateTime  @default(now()) @map("created_at")
  lastAccessedAt     DateTime? @map("last_accessed_at")
  // Retention (NULL = permanent, default)
  contentExpiresAt   DateTime? @map("content_expires_at")
  // Summary fields (populated after run completes)
  decisionCode       String?   @map("decision_code")     // 1-5 rating or "other"
  decisionText       String?   @map("decision_text")     // LLM-generated summary
  summarizedAt       DateTime? @map("summarized_at")     // When summary was generated

  run      Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario Scenario? @relation(fields: [scenarioId], references: [id])

  @@index([runId])
  @@index([scenarioId])
  @@index([modelId])
  @@map("transcripts")
}

model Scenario {
  id           String    @id @default(cuid())
  definitionId String    @map("definition_id")
  name         String
  content      Json      @db.JsonB
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")

  definition  Definition   @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  transcripts Transcript[]
  runSelections RunScenarioSelection[]

  @@index([definitionId])
  @@map("scenarios")
}

// Join table to track which scenarios were sampled for a run
model RunScenarioSelection {
  id         String   @id @default(cuid())
  runId      String   @map("run_id")
  scenarioId String   @map("scenario_id")
  createdAt  DateTime @default(now()) @map("created_at")

  run      Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([runId, scenarioId])
  @@index([runId])
  @@index([scenarioId])
  @@map("run_scenario_selections")
}

// ============================================================================
// ANALYSIS & EXPERIMENTS
// ============================================================================

model Experiment {
  id           String   @id @default(cuid())
  name         String
  hypothesis   String?
  analysisPlan Json?    @map("analysis_plan") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  runs        Run[]
  comparisons RunComparison[]

  @@map("experiments")
}

model RunComparison {
  id              String   @id @default(cuid())
  experimentId    String?  @map("experiment_id")
  baselineRunId   String   @map("baseline_run_id")
  comparisonRunId String   @map("comparison_run_id")
  deltaData       Json?    @map("delta_data") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at")

  experiment    Experiment? @relation(fields: [experimentId], references: [id])
  baselineRun   Run         @relation("BaselineRun", fields: [baselineRunId], references: [id])
  comparisonRun Run         @relation("ComparisonRun", fields: [comparisonRunId], references: [id])

  @@index([experimentId])
  @@index([baselineRunId])
  @@index([comparisonRunId])
  @@map("run_comparisons")
}

model AnalysisResult {
  id           String         @id @default(cuid())
  runId        String         @map("run_id")
  analysisType String         @map("analysis_type")
  inputHash    String         @map("input_hash")
  codeVersion  String         @map("code_version")
  output       Json           @db.JsonB
  status       AnalysisStatus @default(CURRENT)
  createdAt    DateTime       @default(now()) @map("created_at")

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([analysisType])
  @@index([status])
  @@map("analysis_results")
}

enum AnalysisStatus {
  CURRENT
  SUPERSEDED
}

model Rubric {
  id        String   @id @default(cuid())
  version   Int      @unique
  content   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")

  @@map("rubrics")
}

// ============================================================================
// COHORTS (for segment analysis)
// ============================================================================

model Cohort {
  id        String   @id @default(cuid())
  name      String
  criteria  Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("cohorts")
}
