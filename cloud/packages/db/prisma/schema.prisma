generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION
// ============================================================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String?
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  apiKeys ApiKey[]

  // Audit relations
  auditLogs          AuditLog[]
  createdDefinitions Definition[] @relation("DefinitionCreator")
  deletedDefinitions Definition[] @relation("DefinitionDeleter")
  createdRuns        Run[]        @relation("RunCreator")
  deletedRuns        Run[]        @relation("RunDeleter")
  createdTags        Tag[]        @relation("TagCreator")
  createdLlmModels   LlmModel[]   @relation("LlmModelCreator")

  @@map("users")
}

model ApiKey {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  name      String
  keyHash   String    @unique @map("key_hash")
  keyPrefix String    @map("key_prefix") @db.VarChar(12)
  lastUsed  DateTime? @map("last_used")
  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([keyPrefix])
  @@index([userId])
  @@map("api_keys")
}

// ============================================================================
// OAUTH 2.1 (MCP Authentication)
// ============================================================================

model OAuthClient {
  id                      String   @id @default(cuid())
  clientId                String   @unique @map("client_id")
  clientSecretHash        String   @map("client_secret_hash")
  clientName              String?  @map("client_name")
  redirectUris            String[] @map("redirect_uris")
  tokenEndpointAuthMethod String   @default("client_secret_post") @map("token_endpoint_auth_method")
  grantTypes              String[] @default(["authorization_code", "refresh_token"]) @map("grant_types")
  responseTypes           String[] @default(["code"]) @map("response_types")
  scope                   String   @default("mcp:read mcp:write")
  createdAt               DateTime @default(now()) @map("created_at")

  refreshTokens OAuthRefreshToken[]

  @@map("oauth_clients")
}

model OAuthRefreshToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique @map("token_hash")
  clientId  String   @map("client_id")
  userId    String   @map("user_id")
  scope     String
  resource  String
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  client OAuthClient @relation(fields: [clientId], references: [clientId], onDelete: Cascade)

  @@index([clientId])
  @@index([userId])
  @@index([expiresAt])
  @@map("oauth_refresh_tokens")
}

// ============================================================================
// CORE DOMAIN
// ============================================================================

model Definition {
  id                String    @id @default(cuid())
  parentId          String?   @map("parent_id")
  name              String
  content           Json      @db.JsonB
  expansionProgress Json?     @map("expansion_progress") @db.JsonB
  expansionDebug    Json?     @map("expansion_debug") @db.JsonB
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  lastAccessedAt    DateTime? @map("last_accessed_at")
  deletedAt         DateTime? @map("deleted_at")

  // Audit fields
  createdByUserId String? @map("created_by_user_id")
  deletedByUserId String? @map("deleted_by_user_id")

  parent   Definition?  @relation("DefinitionVersions", fields: [parentId], references: [id])
  children Definition[] @relation("DefinitionVersions")

  runs      Run[]
  scenarios Scenario[]
  tags      DefinitionTag[]

  // Audit relations
  createdBy User? @relation("DefinitionCreator", fields: [createdByUserId], references: [id])
  deletedBy User? @relation("DefinitionDeleter", fields: [deletedByUserId], references: [id])

  // Cost visibility - per-definition token statistics (P3)
  tokenStatistics ModelTokenStatistics[]

  @@index([parentId])
  @@map("definitions")
}

model Tag {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  // Audit fields
  createdByUserId String? @map("created_by_user_id")

  definitions DefinitionTag[]

  // Audit relations
  createdBy User? @relation("TagCreator", fields: [createdByUserId], references: [id])

  @@map("tags")
}

model DefinitionTag {
  id           String    @id @default(cuid())
  definitionId String    @map("definition_id")
  tagId        String    @map("tag_id")
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")

  definition Definition @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  tag        Tag        @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([definitionId, tagId])
  @@index([definitionId])
  @@index([tagId])
  @@map("definition_tags")
}

model Run {
  id                 String    @id @default(cuid())
  name               String?   @map("name")
  definitionId       String    @map("definition_id")
  experimentId       String?   @map("experiment_id")
  status             RunStatus @default(PENDING)
  config             Json      @db.JsonB
  progress           Json?     @db.JsonB
  summarizeProgress  Json?     @map("summarize_progress") @db.JsonB
  startedAt          DateTime? @map("started_at")
  completedAt        DateTime? @map("completed_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  lastAccessedAt     DateTime? @map("last_accessed_at")
  deletedAt          DateTime? @map("deleted_at")
  // Retention settings (for future pruning)
  retentionDays      Int?      @map("retention_days")
  archivePermanently Boolean   @default(true) @map("archive_permanently")

  // Audit fields
  createdByUserId String? @map("created_by_user_id")
  deletedByUserId String? @map("deleted_by_user_id")

  definition Definition  @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  experiment Experiment? @relation(fields: [experimentId], references: [id])

  transcripts     Transcript[]
  analysisResults AnalysisResult[]
  baselineFor     RunComparison[]  @relation("BaselineRun")
  comparisonFor   RunComparison[]  @relation("ComparisonRun")
  scenarioSelections RunScenarioSelection[]
  probeResults    ProbeResult[]

  // Audit relations
  createdBy User? @relation("RunCreator", fields: [createdByUserId], references: [id])
  deletedBy User? @relation("RunDeleter", fields: [deletedByUserId], references: [id])

  @@index([definitionId])
  @@index([experimentId])
  @@index([status])
  @@map("runs")
}

enum RunStatus {
  PENDING
  RUNNING
  PAUSED
  SUMMARIZING   // Probing complete, generating summaries
  COMPLETED
  FAILED
  CANCELLED
}

model Transcript {
  id                 String    @id @default(cuid())
  runId              String    @map("run_id")
  scenarioId         String?   @map("scenario_id")
  // Model versioning (renamed from target_model for consistency)
  modelId            String    @map("model_id")
  modelVersion       String?   @map("model_version")
  // Definition snapshot (captures exact definition at run time)
  definitionSnapshot Json?     @map("definition_snapshot") @db.JsonB
  // Transcript content
  content            Json      @db.JsonB
  turnCount          Int       @map("turn_count")
  tokenCount         Int       @map("token_count")
  durationMs         Int       @map("duration_ms")
  // Cost tracking (USD, computed from token counts and model pricing)
  estimatedCost      Float?    @map("estimated_cost")
  createdAt          DateTime  @default(now()) @map("created_at")
  lastAccessedAt     DateTime? @map("last_accessed_at")
  // Retention (NULL = permanent, default)
  contentExpiresAt   DateTime? @map("content_expires_at")
  // Summary fields (populated after run completes)
  decisionCode       String?   @map("decision_code")     // 1-5 rating or "other"
  decisionText       String?   @map("decision_text")     // LLM-generated summary
  summarizedAt       DateTime? @map("summarized_at")     // When summary was generated
  // Soft delete
  deletedAt          DateTime? @map("deleted_at")

  run      Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario Scenario? @relation(fields: [scenarioId], references: [id])

  @@index([runId])
  @@index([scenarioId])
  @@index([modelId])
  @@index([deletedAt])
  @@map("transcripts")
}

model Scenario {
  id           String    @id @default(cuid())
  definitionId String    @map("definition_id")
  name         String
  content      Json      @db.JsonB
  createdAt    DateTime  @default(now()) @map("created_at")
  deletedAt    DateTime? @map("deleted_at")

  definition  Definition   @relation(fields: [definitionId], references: [id], onDelete: Cascade)
  transcripts Transcript[]
  runSelections RunScenarioSelection[]
  probeResults  ProbeResult[]

  @@index([definitionId])
  @@map("scenarios")
}

// Join table to track which scenarios were sampled for a run
model RunScenarioSelection {
  id         String   @id @default(cuid())
  runId      String   @map("run_id")
  scenarioId String   @map("scenario_id")
  createdAt  DateTime @default(now()) @map("created_at")

  run      Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([runId, scenarioId])
  @@index([runId])
  @@index([scenarioId])
  @@map("run_scenario_selections")
}

// ============================================================================
// JOB RESULTS (Probe outcome tracking)
// ============================================================================

model ProbeResult {
  id          String            @id @default(cuid())
  runId       String            @map("run_id")
  scenarioId  String            @map("scenario_id")
  modelId     String            @map("model_id")
  status      ProbeResultStatus
  // Success fields
  transcriptId   String?        @map("transcript_id")
  durationMs     Int?           @map("duration_ms")
  inputTokens    Int?           @map("input_tokens")
  outputTokens   Int?           @map("output_tokens")
  // Failure fields
  errorCode    String?          @map("error_code")
  errorMessage String?          @map("error_message")
  retryCount   Int              @default(0) @map("retry_count")
  // Timestamps
  createdAt    DateTime         @default(now()) @map("created_at")
  completedAt  DateTime?        @map("completed_at")

  run      Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  scenario Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([runId, scenarioId, modelId])
  @@index([runId])
  @@index([scenarioId])
  @@index([modelId])
  @@index([status])
  @@map("probe_results")
}

enum ProbeResultStatus {
  SUCCESS
  FAILED
}

// ============================================================================
// ANALYSIS & EXPERIMENTS
// ============================================================================

model Experiment {
  id           String   @id @default(cuid())
  name         String
  hypothesis   String?
  analysisPlan Json?    @map("analysis_plan") @db.JsonB
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  runs        Run[]
  comparisons RunComparison[]

  @@map("experiments")
}

model RunComparison {
  id              String   @id @default(cuid())
  experimentId    String?  @map("experiment_id")
  baselineRunId   String   @map("baseline_run_id")
  comparisonRunId String   @map("comparison_run_id")
  deltaData       Json?    @map("delta_data") @db.JsonB
  createdAt       DateTime @default(now()) @map("created_at")

  experiment    Experiment? @relation(fields: [experimentId], references: [id])
  baselineRun   Run         @relation("BaselineRun", fields: [baselineRunId], references: [id])
  comparisonRun Run         @relation("ComparisonRun", fields: [comparisonRunId], references: [id])

  @@index([experimentId])
  @@index([baselineRunId])
  @@index([comparisonRunId])
  @@map("run_comparisons")
}

model AnalysisResult {
  id           String         @id @default(cuid())
  runId        String         @map("run_id")
  analysisType String         @map("analysis_type")
  inputHash    String         @map("input_hash")
  codeVersion  String         @map("code_version")
  output       Json           @db.JsonB
  status       AnalysisStatus @default(CURRENT)
  createdAt    DateTime       @default(now()) @map("created_at")
  // Soft delete
  deletedAt    DateTime?      @map("deleted_at")

  run Run @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@index([analysisType])
  @@index([status])
  @@index([deletedAt])
  @@map("analysis_results")
}

enum AnalysisStatus {
  CURRENT
  SUPERSEDED
}

model Rubric {
  id        String   @id @default(cuid())
  version   Int      @unique
  content   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")

  @@map("rubrics")
}

// ============================================================================
// COHORTS (for segment analysis)
// ============================================================================

model Cohort {
  id        String   @id @default(cuid())
  name      String
  criteria  Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("cohorts")
}

// ============================================================================
// LLM PROVIDERS & MODELS
// ============================================================================

model LlmProvider {
  id                  String   @id @default(cuid())
  name                String   @unique
  displayName         String   @map("display_name")
  maxParallelRequests Int      @default(1) @map("max_parallel_requests")
  requestsPerMinute   Int      @default(60) @map("requests_per_minute")
  isEnabled           Boolean  @default(true) @map("is_enabled")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  models LlmModel[]

  @@map("llm_providers")
}

model LlmModel {
  id                   String         @id @default(cuid())
  providerId           String         @map("provider_id")
  modelId              String         @map("model_id")
  displayName          String         @map("display_name")
  costInputPerMillion  Decimal        @map("cost_input_per_million") @db.Decimal(10, 4)
  costOutputPerMillion Decimal        @map("cost_output_per_million") @db.Decimal(10, 4)
  status               LlmModelStatus @default(ACTIVE)
  isDefault            Boolean        @default(false) @map("is_default")
  apiConfig            Json?          @map("api_config") @db.JsonB
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  // Audit fields
  createdByUserId String? @map("created_by_user_id")

  provider LlmProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  // Audit relations
  createdBy User? @relation("LlmModelCreator", fields: [createdByUserId], references: [id])

  // Cost visibility - token statistics for cost prediction
  tokenStatistics ModelTokenStatistics[]

  @@unique([providerId, modelId])
  @@index([providerId])
  @@index([status])
  @@map("llm_models")
}

enum LlmModelStatus {
  ACTIVE
  DEPRECATED
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json     @db.JsonB
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// ============================================================================
// COST VISIBILITY - Token Statistics
// ============================================================================

model ModelTokenStatistics {
  id              String     @id @default(cuid())
  modelId         String     @map("model_id")
  definitionId    String?    @map("definition_id")
  avgInputTokens  Decimal    @default(100) @map("avg_input_tokens") @db.Decimal(10, 2)
  avgOutputTokens Decimal    @default(900) @map("avg_output_tokens") @db.Decimal(10, 2)
  sampleCount     Int        @default(0) @map("sample_count")
  lastUpdatedAt   DateTime   @updatedAt @map("last_updated_at")
  createdAt       DateTime   @default(now()) @map("created_at")

  model      LlmModel    @relation(fields: [modelId], references: [id], onDelete: Cascade)
  definition Definition? @relation(fields: [definitionId], references: [id], onDelete: SetNull)

  @@unique([modelId, definitionId])
  @@index([modelId])
  @@index([definitionId])
  @@map("model_token_statistics")
}

// ============================================================================
// AUDIT LOGGING
// ============================================================================

model AuditLog {
  id         String   @id @default(cuid())
  action     String   // CREATE, UPDATE, DELETE, ACTION
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  userId     String?  @map("user_id")
  metadata   Json?    @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@map("audit_logs")
}
